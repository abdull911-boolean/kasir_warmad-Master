/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package kasir_warmad;

import kasir_warmad.sistem.Koneksi;
import kasir_warmad.sistem.Session;
import com.formdev.flatlaf.extras.FlatSVGIcon;
import desain.GradientPanel;
import com.formdev.flatlaf.intellijthemes.FlatArcOrangeIJTheme;
import javax.swing.UIManager;
import java.awt.Font;
import java.awt.Frame;
import java.math.BigDecimal;
import javax.swing.table.DefaultTableModel;
import java.sql.Connection;
import java.sql.Statement;
import java.sql.ResultSet;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import kasir_warmad.tampilan.Supplier;

public class Dashboard extends javax.swing.JFrame {

    /**
     * Creates new form Dashboard
     */
    public Dashboard(String role) {
        initComponents();

        Logo.setIcon(new FlatSVGIcon("image/Log.svg", 100, 50));

        if (role.equalsIgnoreCase("kasir")) {
            LaporanD.setVisible(false);
        } else if (role.equalsIgnoreCase("admin")) {
            LaporanD.setVisible(true);
        } else {
            LaporanD.setVisible(false);
        }
    }

    private void loadDataTransaksiTerbaru() {
        DefaultTableModel model = new DefaultTableModel();
        model.addColumn("Kode Barang");
        model.addColumn("Nama Barang");
        model.addColumn("Jumlah Terjual");
        model.addColumn("Total Harga");
        model.addColumn("Metode Pembayaran");
        model.addColumn("Tanggal");

        try {
            String sql = "SELECT bj.barcode_barang, bj.nama_barang, dt.jumlah, tk.total_harga, "
                    + "tk.metode_pembayaran, tk.tanggal "
                    + "FROM transaksi_kasir tk "
                    + "JOIN detail_transaksi_pelanggan dt ON tk.id_transaksi_kasir = dt.id_transaksi_kasir "
                    + "JOIN barang_jual bj ON dt.id_barang_jual = bj.id_barang_jual "
                    + "ORDER BY tk.tanggal DESC "
                    + "LIMIT 20";  // atau LIMIT sesuai kebutuhan

            Connection conn = Koneksi.getKoneksi();
            Statement stm = conn.createStatement();
            ResultSet res = stm.executeQuery(sql);

            while (res.next()) {
                model.addRow(new Object[]{
                    res.getString("barcode_barang"),
                    res.getString("nama_barang"),
                    res.getInt("jumlah"),
                    utils.RupiahUtil.format(BigDecimal.valueOf(res.getDouble("total_harga"))),
                    res.getString("metode_pembayaran"),
                    res.getTimestamp("tanggal")
                });
            }

            TabeltransaksibaruD.setModel(model);

        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error Transaksi Terbaru: " + e.getMessage());
        }
    }

    private void loadDataBarangTerlaris() {
        DefaultTableModel model = new DefaultTableModel();
        model.addColumn("Kode Barang");
        model.addColumn("Nama Barang");
        model.addColumn("Kategori");
        model.addColumn("Stok");
        model.addColumn("Total Terjual");

        try {
            String sql = "SELECT bj.barcode_barang, bj.nama_barang, bj.kategori_barang, sg.jumlah_stok, "
                    + "SUM(dt.jumlah) AS total_terjual "
                    + "FROM detail_transaksi_pelanggan dt "
                    + "JOIN barang_jual bj ON dt.id_barang_jual = bj.id_barang_jual "
                    + "LEFT JOIN stok_gudang sg ON bj.id_barang_jual = sg.id_barang_jual "
                    + "GROUP BY bj.barcode_barang, bj.nama_barang, bj.kategori_barang, sg.jumlah_stok "
                    + "ORDER BY total_terjual DESC "
                    + "LIMIT 10";

            Connection conn = Koneksi.getKoneksi();
            Statement stm = conn.createStatement();
            ResultSet res = stm.executeQuery(sql);

            while (res.next()) {
                model.addRow(new Object[]{
                    res.getString("barcode_barang"),
                    res.getString("nama_barang"),
                    res.getString("kategori_barang"),
                    res.getInt("jumlah_stok"),
                    res.getInt("total_terjual")
                });
            }

            TabelbarangterlarisD.setModel(model);

        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error Barang Terlaris: " + e.getMessage());
        }

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        panelluar1D = new javax.swing.JPanel();
        paneltombolD = new GradientPanel();
        TransaksiD = new javax.swing.JButton();
        LaporanD = new javax.swing.JButton();
        KelolabarangD = new javax.swing.JButton();
        StokbarangD = new javax.swing.JButton();
        Logo = new javax.swing.JLabel();
        returBtn = new javax.swing.JButton();
        supplierBtn = new javax.swing.JButton();
        paneltabelD = new GradientPanel();
        ScrolltransaksibaruD = new javax.swing.JScrollPane();
        TabeltransaksibaruD = new javax.swing.JTable();
        ScrollbarangterlarisD = new javax.swing.JScrollPane();
        TabelbarangterlarisD = new javax.swing.JTable();
        LtransaksibaruD = new javax.swing.JLabel();
        LbarangterlarisD = new javax.swing.JLabel();
        LogoutD = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setPreferredSize(new java.awt.Dimension(1244, 768));
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowOpened(java.awt.event.WindowEvent evt) {
                formWindowOpened(evt);
            }
        });

        panelluar1D.setBackground(new java.awt.Color(255, 255, 255));
        panelluar1D.setPreferredSize(new java.awt.Dimension(1245, 768));

        paneltombolD.setBackground(new java.awt.Color(255, 255, 255));

        TransaksiD.setFont(new java.awt.Font("Segoe UI Variable", 1, 12)); // NOI18N
        TransaksiD.setText("Transaksi");
        TransaksiD.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                TransaksiDActionPerformed(evt);
            }
        });

        LaporanD.setFont(new java.awt.Font("Segoe UI Variable", 1, 12)); // NOI18N
        LaporanD.setText("Laporan");
        LaporanD.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                LaporanDActionPerformed(evt);
            }
        });

        KelolabarangD.setFont(new java.awt.Font("Segoe UI Variable", 1, 12)); // NOI18N
        KelolabarangD.setText("Kelola Barang");
        KelolabarangD.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                KelolabarangDActionPerformed(evt);
            }
        });

        StokbarangD.setFont(new java.awt.Font("Segoe UI Variable", 1, 12)); // NOI18N
        StokbarangD.setText("Stok Barang");
        StokbarangD.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                StokbarangDActionPerformed(evt);
            }
        });

        Logo.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        Logo.setIcon(new FlatSVGIcon("image/Log.svg"));

        returBtn.setFont(new java.awt.Font("Segoe UI Variable", 1, 12)); // NOI18N
        returBtn.setText("Retur");
        returBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                returBtnActionPerformed(evt);
            }
        });

        supplierBtn.setFont(new java.awt.Font("Segoe UI Variable", 1, 12)); // NOI18N
        supplierBtn.setText("Supplier");
        supplierBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                supplierBtnActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout paneltombolDLayout = new javax.swing.GroupLayout(paneltombolD);
        paneltombolD.setLayout(paneltombolDLayout);
        paneltombolDLayout.setHorizontalGroup(
            paneltombolDLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(paneltombolDLayout.createSequentialGroup()
                .addGap(20, 20, 20)
                .addGroup(paneltombolDLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(Logo, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(paneltombolDLayout.createSequentialGroup()
                        .addGroup(paneltombolDLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(StokbarangD, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(KelolabarangD, javax.swing.GroupLayout.DEFAULT_SIZE, 142, Short.MAX_VALUE)
                            .addComponent(LaporanD, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(TransaksiD, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(returBtn, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(supplierBtn, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );
        paneltombolDLayout.setVerticalGroup(
            paneltombolDLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(paneltombolDLayout.createSequentialGroup()
                .addGap(47, 47, 47)
                .addComponent(Logo, javax.swing.GroupLayout.PREFERRED_SIZE, 85, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(TransaksiD)
                .addGap(18, 18, 18)
                .addComponent(LaporanD)
                .addGap(18, 18, 18)
                .addComponent(KelolabarangD)
                .addGap(18, 18, 18)
                .addComponent(StokbarangD)
                .addGap(18, 18, 18)
                .addComponent(returBtn)
                .addGap(18, 18, 18)
                .addComponent(supplierBtn)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        paneltabelD.setBackground(new java.awt.Color(255, 255, 255));

        TabeltransaksibaruD.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        ScrolltransaksibaruD.setViewportView(TabeltransaksibaruD);

        TabelbarangterlarisD.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        ScrollbarangterlarisD.setViewportView(TabelbarangterlarisD);

        LtransaksibaruD.setFont(new java.awt.Font("Arial", 1, 14)); // NOI18N
        LtransaksibaruD.setForeground(new java.awt.Color(255, 255, 255));
        LtransaksibaruD.setText("TRANSAKSI TERBARU");

        LbarangterlarisD.setFont(new java.awt.Font("Arial", 1, 14)); // NOI18N
        LbarangterlarisD.setForeground(new java.awt.Color(255, 255, 255));
        LbarangterlarisD.setText("BARANG TERLARIS");

        javax.swing.GroupLayout paneltabelDLayout = new javax.swing.GroupLayout(paneltabelD);
        paneltabelD.setLayout(paneltabelDLayout);
        paneltabelDLayout.setHorizontalGroup(
            paneltabelDLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(paneltabelDLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(paneltabelDLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(ScrolltransaksibaruD, javax.swing.GroupLayout.PREFERRED_SIZE, 990, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(ScrollbarangterlarisD, javax.swing.GroupLayout.PREFERRED_SIZE, 990, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(LtransaksibaruD, javax.swing.GroupLayout.PREFERRED_SIZE, 160, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(LbarangterlarisD, javax.swing.GroupLayout.PREFERRED_SIZE, 160, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(31, Short.MAX_VALUE))
        );
        paneltabelDLayout.setVerticalGroup(
            paneltabelDLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(paneltabelDLayout.createSequentialGroup()
                .addComponent(LtransaksibaruD, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(ScrolltransaksibaruD, javax.swing.GroupLayout.PREFERRED_SIZE, 210, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(33, 33, 33)
                .addComponent(LbarangterlarisD, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(ScrollbarangterlarisD, javax.swing.GroupLayout.PREFERRED_SIZE, 210, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        LogoutD.setFont(new java.awt.Font("Segoe UI Variable", 1, 12)); // NOI18N
        LogoutD.setText("Log Out");
        LogoutD.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                LogoutDActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout panelluar1DLayout = new javax.swing.GroupLayout(panelluar1D);
        panelluar1D.setLayout(panelluar1DLayout);
        panelluar1DLayout.setHorizontalGroup(
            panelluar1DLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(panelluar1DLayout.createSequentialGroup()
                .addComponent(paneltombolD, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 57, Short.MAX_VALUE)
                .addGroup(panelluar1DLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, panelluar1DLayout.createSequentialGroup()
                        .addComponent(LogoutD)
                        .addGap(24, 24, 24))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, panelluar1DLayout.createSequentialGroup()
                        .addComponent(paneltabelD, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addContainerGap())))
        );
        panelluar1DLayout.setVerticalGroup(
            panelluar1DLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(paneltombolD, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, panelluar1DLayout.createSequentialGroup()
                .addGap(19, 19, 19)
                .addComponent(LogoutD)
                .addGap(18, 18, 18)
                .addComponent(paneltabelD, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGap(14, 14, 14))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(panelluar1D, javax.swing.GroupLayout.DEFAULT_SIZE, 1258, Short.MAX_VALUE)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(panelluar1D, javax.swing.GroupLayout.DEFAULT_SIZE, 605, Short.MAX_VALUE)
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void LogoutDActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_LogoutDActionPerformed
        login lg = new login();
        lg.setVisible(true);
        lg.pack();
        lg.setLocationRelativeTo(null);
        dispose();
        javax.swing.JOptionPane.showMessageDialog(null, "ANDA BERHASIL LOGOUT");
    }//GEN-LAST:event_LogoutDActionPerformed

    private void StokbarangDActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_StokbarangDActionPerformed
        Stok_barang sb = new Stok_barang();
        sb.setVisible(true);
        sb.pack();
        sb.setLocationRelativeTo(null);
        dispose();
    }//GEN-LAST:event_StokbarangDActionPerformed

    private void KelolabarangDActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_KelolabarangDActionPerformed
        Kelola_barang kb = new Kelola_barang();
        kb.setVisible(true);
        kb.pack();
        kb.setLocationRelativeTo(null);
        dispose();
    }//GEN-LAST:event_KelolabarangDActionPerformed

    private void LaporanDActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_LaporanDActionPerformed
        Laporan la = new Laporan();
        la.setVisible(true);
        la.pack();
        la.setLocationRelativeTo(null);
        dispose();
    }//GEN-LAST:event_LaporanDActionPerformed

    private void TransaksiDActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_TransaksiDActionPerformed
        Transaksi t = new Transaksi();       // buat objek
        t.setLocationRelativeTo(null);       // posisikan di tengah
        t.setVisible(true);  
        dispose();// tampilkan
    }//GEN-LAST:event_TransaksiDActionPerformed

    private void formWindowOpened(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowOpened
        loadDataTransaksiTerbaru();
        loadDataBarangTerlaris();
    }//GEN-LAST:event_formWindowOpened

    private void returBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_returBtnActionPerformed
        // TODO add your handling code here:
        Retur r = new Retur();
        r.setVisible(true);
        r.setLocationRelativeTo(null);
        dispose();
    }//GEN-LAST:event_returBtnActionPerformed

    private void supplierBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_supplierBtnActionPerformed
        // TODO add your handling code here:
        Supplier s = new Supplier(new JFrame(), true);
        s.setVisible(true);
        s.setLocationRelativeTo(null);
    }//GEN-LAST:event_supplierBtnActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            UIManager.setLookAndFeel(new FlatArcOrangeIJTheme());
            UIManager.put("Button.arc", 999);
            UIManager.put("defaultFont", new Font("Poppins", Font.BOLD, 14));

        } catch (Exception ex) {
            System.err.println("Gagal mengatur tema FlatLaf Arc Orange.");
            ex.printStackTrace();
        }

        //</editor-fold>
  try {
            UIManager.setLookAndFeel(new FlatArcOrangeIJTheme());
            UIManager.put("Button.arc", 999);
            UIManager.put("defaultFont", new Font("Poppins", Font.BOLD, 14));

        } catch (Exception ex) {
            System.err.println("Gagal mengatur tema FlatLaf Arc Orange.");
            ex.printStackTrace();
        }

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new Dashboard(Session.getCurrentUserRole()).setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton KelolabarangD;
    private javax.swing.JButton LaporanD;
    private javax.swing.JLabel LbarangterlarisD;
    private javax.swing.JLabel Logo;
    private javax.swing.JButton LogoutD;
    private javax.swing.JLabel LtransaksibaruD;
    private javax.swing.JScrollPane ScrollbarangterlarisD;
    private javax.swing.JScrollPane ScrolltransaksibaruD;
    private javax.swing.JButton StokbarangD;
    private javax.swing.JTable TabelbarangterlarisD;
    private javax.swing.JTable TabeltransaksibaruD;
    private javax.swing.JButton TransaksiD;
    private javax.swing.JPanel panelluar1D;
    private javax.swing.JPanel paneltabelD;
    private javax.swing.JPanel paneltombolD;
    private javax.swing.JButton returBtn;
    private javax.swing.JButton supplierBtn;
    // End of variables declaration//GEN-END:variables
}
